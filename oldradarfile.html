
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WeatherPower - Full Hybrid Radar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; background: #101010; color: white; font-family: Arial, sans-serif; }
    #map { height: calc(100% - 60px); }
    #controls {
      background: #1c1c1c;
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 14px;
    }
    select, button {
      background: #333;
      color: white;
      border: none;
      padding: 6px;
      border-radius: 4px;
    }
    #timestamp {
      color: #bbb;
      margin-left: auto;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

</head>
<body>
  <div id="controls">
    <label>Mode:</label>
    <select id="mode">
      <option value="reflectivity">Reflectivity (RainViewer)</option>
      <option value="velocity">Velocity (NOAA/IEM)</option>
    </select>

    <label>Radar Site:</label>
    <select id="tower">
      <option value="KTLX">KTLX (OKC)</option>
      <option value="KFWS">KFWS (DFW)</option>
      <option value="KSHV">KSHV (Shreveport)</option>
      <option value="KLBB">KLBB (Lubbock)</option>
    </select>

    <button onclick="locateMe()">üìç Locate Me</button>
    <div id="timestamp">Loading...</div>
  </div>
  
<div id="topbar" style="
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 48px;
  background: #1d2c4b;
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  font-family: sans-serif;
  z-index: 10000;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
">
  <div style="display: flex; align-items: center; gap: 10px;">
    <img src="logo.png" alt="WeatherPower" style="height: 28px;">
    <span style="font-weight: bold; font-size: 16px;">WeatherPower</span>
  </div>
  <div style="display: flex; gap: 20px; font-size: 14px;">
    <button style="background:none;border:none;color:white;cursor:pointer;" onclick="setMode('radar')">üì° Radar</button>
    <button style="background:none;border:none;color:white;cursor:pointer;" onclick="setMode('satellite')">üõ∞ Satellite</button>
    <button style="background:none;border:none;color:white;cursor:pointer;" onclick="setMode('outlooks')">‚ö† Outlooks</button>
    <button style="background:none;border:none;color:white;cursor:pointer;" onclick="toggleReplay()">üîÅ Replay Mode</button>
  </div>
  <div style="display: flex; align-items: center; gap: 8px;">
    <input type="text" id="locationSearch" placeholder="Search" style="padding:4px 6px;border-radius:4px;border:none;">
    <button onclick="locateUser()" style="background:#ffb300;border:none;border-radius:20px;padding:6px 12px;color:black;">üìç</button>
    <div style="background:#ff5722;color:white;padding:4px 10px;border-radius:12px;font-weight:bold;">üîî <span id="alertCount">0</span></div>
  </div>
</div>

<div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([34.2, -95], 6);
    const token = 'sk.eyJ1IjoibnVsbHdlYXRoZXIiLCJhIjoiY21ibDhrY3BwMTF6eDJscGs5bHByeG9meiJ9.f2ztfzK_Xvxx4S40o0ZKUw';

    L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token=${token}`, {
      tileSize: 512, zoomOffset: -1
    }).addTo(map);

    const mode = document.getElementById("mode");
    const tower = document.getElementById("tower");
    const timestamp = document.getElementById("timestamp");

    let radarLayers = [], currentFrame = 0, loop, rainViewerFrames = [];

    function loadRainViewer() {
      if (loop) clearInterval(loop);
      radarLayers.forEach(l => map.removeLayer(l));
      radarLayers = [];

      fetch("https://api.rainviewer.com/public/weather-maps.json")
        .then(res => res.json())
        .then(data => {
          rainViewerFrames = data.radar.past.slice(-6);
          rainViewerFrames.forEach((frame, i) => {
            const tile = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${frame.path}/256/{z}/{x}/{y}/2/1_1.png`, {
              tileSize: 256,
              opacity: i === 0 ? 0.85 : 0,
              zIndex: 9
            });
            tile.addTo(map);
            radarLayers.push(tile);
          });

          currentFrame = 0;
          loop = setInterval(() => {
            radarLayers.forEach((l, i) => l.setOpacity(i === currentFrame ? 0.85 : 0));
            timestamp.textContent = "RainViewer - Frame " + (currentFrame + 1);
            currentFrame = (currentFrame + 1) % radarLayers.length;
          }, 1000);
        });
    }

    function loadVelocityTiles() {
      if (loop) clearInterval(loop);
      radarLayers.forEach(l => map.removeLayer(l));
      radarLayers = [];

      const site = tower.value;
      for (let i = 0; i < 6; i++) {
        const url = `https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/ridge::N0S::${site}::${i}::0::0.png`;
        const tile = L.tileLayer(url, {
          bounds: [[24.396308, -125.0], [49.384358, -66.93457]],
          opacity: i === 0 ? 0.85 : 0,
          zIndex: 9
        });
        tile.addTo(map);
        radarLayers.push(tile);
      }

      currentFrame = 0;
      loop = setInterval(() => {
        radarLayers.forEach((l, idx) => l.setOpacity(idx === currentFrame ? 0.85 : 0));
        timestamp.textContent = "Velocity - Frame " + (currentFrame + 1);
        currentFrame = (currentFrame + 1) % radarLayers.length;
      }, 1000);
    }

    function switchRadar() {
      if (mode.value === "reflectivity") {
        tower.disabled = true;
        loadRainViewer();
      } else {
        tower.disabled = false;
        loadVelocityTiles();
      }
    }

    mode.addEventListener("change", switchRadar);
    tower.addEventListener("change", () => {
      if (mode.value === "velocity") loadVelocityTiles();
    });

    function locateMe() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          map.setView([lat, lon], 8);
          L.circle([lat, lon], {
            radius: 5000, color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.3
          }).addTo(map).bindPopup("You are here").openPopup();
        });
      }
    }

    // Load warnings from NWS
    fetch("https://api.weather.gov/alerts/active")
      .then(res => res.json())
      .then(data => {
        L.geoJSON(data, {
          style: feature => {
            const e = feature.properties.event || '';
            let color = "#00ffff";
            if (e.includes("Tornado")) color = "#ff0000";
            else if (e.includes("Severe Thunderstorm")) color = "#ffff00";
            else if (e.includes("Flash Flood")) color = "#00ff00";
            return { color, weight: 2, fillOpacity: 0.2 };
          },
          onEachFeature: (feature, layer) => {
            const p = feature.properties;
            const bounds = layer.getBounds();
            const popupHTML = `
              <div style='background:#111;color:white;padding:10px;border-left:5px solid ${
                p.event.includes("Tornado") ? "#ff0000" :
                p.event.includes("Severe") ? "#ffff00" : "#00ffff"
              };'>
                <h3 style='margin:0 0 6px 0;'>${p.event.toUpperCase()}</h3>
                <div><strong>Expires:</strong> ${new Date(p.expires).toLocaleTimeString()}</div>
                <div><strong>Areas:</strong> ${p.areaDesc}</div>
              </div>`;
            layer.on("click", () => {
              map.fitBounds(bounds, { padding: [30, 30] });
              layer.bindPopup(popupHTML).openPopup();
            });
          }
        }).addTo(map);
      });

    switchRadar();
  </script>

<script type="text/javascript" src="/unprotected/back_to_spaceship.js?hash=4975d460e508829e8fb64d3962bc44ad35f3a95a"></script>


<script type="text/javascript" src="/unprotected/back_to_spaceship.js?hash=4975d460e508829e8fb64d3962bc44ad35f3a95a"></script>


<script>
  const map = L.map("map").setView([37.8, -96], 4);
  let baseLayer = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

  // Locate Me
  function locateUser() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(pos => {
        map.setView([pos.coords.latitude, pos.coords.longitude], 8);
      });
    }
  }

  // RainViewer Radar Animation
  let radarLayers = [], currentFrame = 0, loop, rainViewerFrames = [];
  function loadRainViewer() {
    fetch("https://api.rainviewer.com/public/weather-maps.json")
      .then(res => res.json())
      .then(data => {
        rainViewerFrames = data.radar.past.slice(-6);
        radarLayers.forEach(l => map.removeLayer(l));
        radarLayers = [];
        rainViewerFrames.forEach((frame, i) => {
          const layer = L.tileLayer(`https://tilecache.rainviewer.com/v2/radar/${frame.path}/256/{z}/{x}/{y}/2/1_1.png`, {
            opacity: i === 0 ? 0.85 : 0,
            zIndex: 8
          });
          layer.addTo(map);
          radarLayers.push(layer);
        });
        currentFrame = 0;
        if (loop) clearInterval(loop);
        loop = setInterval(() => {
          radarLayers.forEach((l, i) => l.setOpacity(i === currentFrame ? 0.85 : 0));
          currentFrame = (currentFrame + 1) % radarLayers.length;
        }, 1000);
      });
  }

  // NWS Warnings
  let nwsWarningsLayer = L.layerGroup().addTo(map);
  let nwsWarningsVisible = true;
  function toggleNWSWarnings() {
    nwsWarningsVisible = !nwsWarningsVisible;
    if (nwsWarningsVisible) {
      nwsWarningsLayer.addTo(map);
    } else {
      map.removeLayer(nwsWarningsLayer);
    }
  }

  function loadNWSWarnings() {
    fetch("https://mesonet.agron.iastate.edu/geojson/warnings.json")
      .then(res => res.json())
      .then(data => {
        nwsWarningsLayer.clearLayers();
        let count = 0;
        data.features.forEach(feature => {
          try {
            const coords = feature.geometry.coordinates;
            const props = feature.properties;
            if (!coords || !props) return;
            let poly = null;
            if (feature.geometry.type === "Polygon") {
              poly = L.polygon(coords.map(ring => ring.map(p => [p[1], p[0]])), {
                color: "red", weight: 2, fillOpacity: 0.3,
                className: "flashing-warning"
              });
            } else if (feature.geometry.type === "MultiPolygon") {
              poly = L.polygon(coords.map(part => part[0].map(p => [p[1], p[0]])), {
                color: "red", weight: 2, fillOpacity: 0.3,
                className: "flashing-warning"
              });
            }
            if (poly) {
              poly.bindPopup(`<b>${props.phenomena} ${props.significance}</b><br>${props.wfo}<br>Until: ${props.expiration}`);
              poly.addTo(nwsWarningsLayer);
              count++;
            }
          } catch (e) {}
        });
        const countElem = document.getElementById("nwsAlertTotal");
        if (countElem) countElem.textContent = count;
      });
  }

  // WeBot Sounds
  const playWeBotSound = (type) => {
    const audio = new Audio(type === "warning" ? "sounds/webot-warning.mp3" : "sounds/webot-watch.mp3");
    audio.play();
  };

  window.addEventListener("load", () => {
    loadRainViewer();
    loadNWSWarnings();
    setInterval(loadNWSWarnings, 120000);
  });
</script>
<style>
  .flashing-warning {
    animation: flashPolygon 1s infinite alternate;
  }
  @keyframes flashPolygon {
    from { fill-opacity: 0.2; }
    to { fill-opacity: 0.6; }
  }
</style>


<script>
// Create a warning layer group
const warningsLayer = L.geoJSON(null, {
  style: function (feature) {
    return {
      color: feature.properties.severity === "Severe" ? "red" : "orange",
      weight: 2,
      fillOpacity: 0.3,
      dashArray: "5, 5"
    };
  },
  onEachFeature: function (feature, layer) {
    const props = feature.properties;
    const name = props.event || "Alert";
    const desc = props.headline || props.description || "Warning issued";
    layer.bindPopup("<strong>" + name + "</strong><br>" + desc);
    layer.on("click", () => {
      map.fitBounds(layer.getBounds());
    });
  }
}).addTo(map);

// Auto-fetch NWS warnings (GeoJSON)
async function loadWarnings() {
  try {
    const resp = await fetch("https://mesonet.agron.iastate.edu/geojson/warnings.json");
    const data = await resp.json();
    warningsLayer.clearLayers();
    warningsLayer.addData(data);
    document.getElementById("alertCount").innerText = data.features.length;
  } catch (e) {
    console.error("Warning load error:", e);
  }
}
setInterval(loadWarnings, 30000);
loadWarnings();
</script>


<script src="js/rainviewer/rainviewer.min.js"></script>
<script src="js/warnings/nws-warnings.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyASS1N5-3BrxmVBFIdhQZUmHny9lxeUmzY",
  authDomain: "weatherpower-5643e.firebaseapp.com",
  databaseURL: "https://weatherpower-5643e-default-rtdb.firebaseio.com",
  projectId: "weatherpower-5643e",
  storageBucket: "weatherpower-5643e.appspot.com",
  messagingSenderId: "681022698521",
  appId: "1:681022698521:web:23ae51481eeedcec3da688"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>
<script src="js/firebase/wewatches.js"></script>

<audio id="severeTone" src="sounds/severe.mp3" preload="auto"></audio>
<audio id="wewatchTone" src="sounds/watch.mp3" preload="auto"></audio>
<script src="js/ui/banner-alerts.js"></script>

<script src="js/controls/locate.js"></script>
<script src="js/controls/replay-toggle.js"></script>
<script src="js/controls/satellite-outlook.js"></script>
<script type="module" src="/we_bot/WeBot.js"></script>
<script>
  setInterval(fetchNWSWarnings, 60000); // start the loop
</script>
<!-- Load WeBot NWS Alert Watcher -->
<script>
  // Start checking every 60 seconds
  setInterval(fetchNWSWarnings, 60000);
  // Optional: run once immediately
  fetchNWSWarnings();
</script>
<script src="/we_bot/we_bot_radar_snapshot.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>






<script type="text/javascript" src="/unprotected/back_to_spaceship.js?hash=4975d460e508829e8fb64d3962bc44ad35f3a95a"></script>

</body>
</html>
